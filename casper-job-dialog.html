<!--
  - Copyright (c) 2014-2016 Neto Ranito & Seabra LDA. All rights reserved.
  -
  - This file is part of casper-common-ui.
  -
  - casper-common-ui is free software: you can redistribute it and/or modify
  - it under the terms of the GNU Affero General Public License as published by
  - the Free Software Foundation, either version 3 of the License, or
  - (at your option) any later version.
  -
  - casper-common-ui  is distributed in the hope that it will be useful,
  - but WITHOUT ANY WARRANTY; without even the implied warranty of
  - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  - GNU General Public License for more details.
  -
  - You should have received a copy of the GNU Affero General Public License
  - along with casper-common-ui.  If not, see <http://www.gnu.org/licenses/>.
  -
 -->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../casper-common-ui/casper-i18n-behavior.html">
<link rel="import" href="../casper-common-ui/casper-socket2.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../vaadin-upload/vaadin-upload.html">

<!--
`casper-login`
@demo demo/index.html
-->
<dom-module id="casper-job-dialog">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-progress {
        display: block;
        margin-top: 5px;
        margin-bottom:  20px;
        width: 100%;
      }

      paper-progress.slow {
        --paper-progress-indeterminate-cycle-duration: 5s;
        --paper-progress-active-color: var(--primary-color);
        --paper-progress-secondary-color: var(--paper-red-100);
      }

      paper-button {
        font-weight: normal;
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
        background-color: #101010;
        color: white;
        margin: 0px;
      }

      paper-dialog {
        max-width: 600px;
        min-width: 400px;
        min-height: 250px;
      }

      .paper-dialog-0 > * {
        padding: 0px;
        margin: 0px;
      }

      #header {
        background-color: black;
        height: 42px;
        color: white;
        padding: 0px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .pager {
        display: block;
        bottom:42px;
        top: 42px;
        left:0;
        right:0;
      }

      .page {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: white;
        margin: 12px;
      }

      #upload {
        top: 0;
        left: 0;
        right: 0;
        bottom: 6px;
      }

      .header {
        fill: white;
        margin: 8px;
      }

      .close {
        fill: white;
        margin: 8px;
      }

      .error_panel {
        display: inline-flex;
        align-items: flex-start;
      }

      .error_pad {
        width: 72px;
        height: 100%;
        margin-right: 12px;
      }

      .error_icon {
        fill: #B94F4F;
        --iron-icon-height: 72px;
        --iron-icon-width: 72px;
      }

      .error_message {
        font-size: 16px;
        font-weight: 500;
        color: #444;
        right: 0;
        top: 0;
        overflow: auto;
        margin: 0;
      }

      .close:hover {
        background-color: var(--primary-color);
      }

      #background {
        background-color: var(--primary-color);
        height: 36px;
        margin: 12px;
        bottom: 0;
        right: 0;
        left: 0;
        width: 50%;
      }
      #submit {
        background-color: var(--primary-color);
        height: 36px;
        margin: 12px;
        bottom: 0;
        right: 0;
        left: 0;
        width: 50%;
        text-align: center;
      }

      #button_container {
        display: flex;
      }
    </style>

    <casper-socket2 id="self_socket"></casper-socket2>
    <paper-tooltip for="close">{{i18n('i18n_close_and_cancel')}}</paper-tooltip>
    <paper-dialog id="dialog" opened modal>
        <div id="header">
          <h2 id="title" class="header">{{i18n('i18n_print_job')}}</h2>
          <iron-icon icon="close" id="close" class="close" on-tap="_closeDialog"></iron-icon>
        </div>
        <div class="pager">
          <div id="status_panel" class="page">
            <template is="dom-repeat" items="{{progress}}">
              <span>{{item.message}}</span>
              <paper-progress indeterminate class="slow"></paper-progress>
            </template>
          </div>
          <div id="upload_panel" class="page">
            <vaadin-upload id="upload"
                         target="[[uploadUrl]]"
                         max-files="1"
                         method="POST"
                         timeout="300000"
                         form-data-name="my-attachment">
            </vaadin-upload>
          </div>
          <div id="error_panel" class="page error_panel">
            <div class="error_pad">
              <iron-icon icon="error-outline" class="error_icon"></iron-icon>
            </div>
            <div class="error_message">
              <h2>[[i18n('i18n_error')]]</h2>
              <span id="error_message"></span>
            </div>
          </div>
        </div>
        <div id="button_container">
          <paper-button id="submit" on-tap="_submitData">{{i18n('i18n_submit')}}</paper-button>
          <paper-button id="background" on-tap="_closeDialog">{{i18n('i18n_cancel')}}</paper-button>
        </div>
    </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'casper-job-dialog',

      properties: {
        socket: {
          type: Object
        },
        jobId: {
          type: String
        },
        iframe: {
          type: Object,
          value: undefined
        },
        uploadUrl: {
          type: String,
          value: "/upload"
        },
        noAuto: {
          type: Boolean,
          value: false
        },
        method: {
          type: String,
          value: 'GET'
        },
        content_type: {
          type: String,
          value: 'application/html'
        },
        handle_as: {
          type: String,
          value: 'html'
        },
        /** component height in px */
        height: {
          type: Number,
          value: 350
        },
        /** Number of progress bars */
        progressCount: {
          type: Number,
          value: 1
        }
      },

      behaviors: [
        Polymer.CasperI18nBehavior
      ],

      ready: function () {
        this.setProgressCount(this.progressCount, true);
      },

      attached: function () {
        if ( this.socket === undefined ) {
          this.socket = this.$.self_socket;
        }
        this.socket.client = this;
        this.onUploadCallback = undefined;
        this.i18nUpdateUpload(this.$.upload);
        this.listen(this.$.upload, 'upload-success', '_uploadSuccess');
        this.listen(this.$.upload, 'upload-request', '_uploadRequest');

        this.$.upload_panel.style.display = 'none';
        this.$.status_panel.style.display = 'none';
        this.$.error_panel.style.display = 'none';

        this.$.submit.style.display = 'none';
        this.$.background.style.width = '100%';
      },

      detached: function () {
        this.unlisten(this.$.upload, 'upload-request', '_uploadRequest');
        this.unlisten(this.$.upload, 'upload-success', '_uploadSuccess');
      },

      subscribeJob: function (jobId) {
        this.$.upload_panel.style.display = 'none';
        this.$.status_panel.style.display = 'block';
        this.$.error_panel.style.display = 'none';
        this.jobId = jobId;
        this.socket.subscribeJob(this.jobId, this._setJobResponse.bind(this));
      },

      _setJobResponse: function (response) {
        this.onCasperNotification(response.status);
      },

      submitJob: function (job) {
        this.$.upload_panel.style.display = 'none';
        this.$.status_panel.style.display = 'block';
        this.$.error_panel.style.display = 'none';
        this._submitedTube = job.tube;
        this.socket.submitJob(job, this.submitJobResponse.bind(this));
      },

      submitJobResponse: function (response) {
        if ( response.success === true ) {
          this.jobId = this._submitedTube + ':' + response.id;
        } else {
          response.status = 'error';
          response.message = [ 'i18n_submit_job_error$tube', { tube: this._submitedTube } ];
          this._updateUI(response);
          this._reportError(response);
        }
      },

      fileUpload: function (onUploadCallback, onUploadCompletedCallback) {
        this.$.upload_panel.style.display = 'block';
        this.$.status_panel.style.display = 'none';
        this.$.error_panel.style.display = 'none';
        this._onUploadCallback = onUploadCallback;
        this._onUploadCompletedCallback = onUploadCompletedCallback;
        this._onUploadCompletedCallbackData = undefined
      },

      setTitle: function (i18n_key) {
        this.$.title.innerHTML = this.i18n(i18n_key);
      },

      setProgressCount: function (count, forced) {
        if ( count !== this.progressCount || forced) {
          this.progressCount = count;
          this.progress = null;
          var pdata = Array.apply(null, { length: this.progressCount }).map(function() { return { message: '\xA0' }; });
          pdata[0].message = this.i18n('i18n_waiting_on_queue');
          this.progress = pdata;
        }
      },

      onSocketOpen: function (message) {
        // empty
      },

      onCasperNotification: function (notification) {
        if ( notification.message ) {
          var idx  = notification.index || 0;
          this.progress[idx].message = this.i18n.apply(this, notification.message);
          this.notifyPath('progress.'+idx+'.message');
        }
        this._updateUI(notification);
      },

      onSocketClose: function (message) {
        this.$.dialog.close();
      },

      _uploadRequest: function (event) {
          event.preventDefault();
          event.detail.xhr.setRequestHeader('Content-Type', 'application/octet-stream');
          event.detail.xhr.setRequestHeader('Content-Disposition', 'form-data; name="'+event.detail.file.formDataName+'"; filename="'+event.detail.file.name+'";');
          event.detail.xhr.send(event.detail.file);
      },

      _uploadSuccess: function (event) {
        if ( event.detail.xhr.status == 200 ) {
          try {
            response = JSON.parse(event.detail.xhr.responseText)
            if ( this._onUploadCallback !== undefined ) {
              this._uploadedTemporaryFile = response.file;
              this._onUploadCallback();
              this._onUploadCallback = undefined;
            }
          } catch (exception) {
            this._reportError(exception);
          }
        }
      },

      _closeDialog: function (event) {
        if ( this.iframe ) {
          this.iframe.style.display = 'none';
        }
        if ( this.jobId ) {
          this.socket.cancelJob(this.jobId);
        }
        if ( undefined !== this._onUploadCompletedCallback ) {
          this._onUploadCompletedCallback(this._onUploadCompletedCallbackData);
          this._onUploadCompletedCallback = undefined;
          this._onUploadCompletedCallbackData = undefined;
        }
        this.$.dialog.close();
      },

      _handlePublicLink: function (notification) {
        if ( notification.public_link !== undefined && notification.status !== 'error' ) {
          if ( this.downloadIframe === undefined ) {
            this.downloadIframe = document.createElement('iframe');
            this.downloadIframe.style.display = 'block';
            this.appendChild(this.downloadIframe);
          }

          try {
            this.downloadIframe.src = notification.public_link;
          } catch (exception) {
            this._reportError(exception);
          }

        }
      },

      _updateUI: function (notification) {
        if ( notification.progress !== undefined ) {
          var progress = parseFloat(notification.progress);

          if ( isNaN(progress) === false ) {
            var idx  = notification.index || 0; idx += 1;
            var pbar = this.$$('paper-progress:nth-of-type('+idx+')');
            pbar.indeterminate = false;
            pbar.value = progress;
          }
        }
        switch (notification.status) {
          case 'in-progress':
            break;
          case 'completed':
            this._handlePublicLink(notification);
            this._onUploadCompletedCallbackData = { link: notification.link };
            this._closeDialog();
            break;
          case 'error':
            this.$.upload_panel.style.display = 'none';
            this.$.status_panel.style.display = 'none';
            this.$.error_panel.style.display = 'inline-flex';
            this.$.error_message.innerHTML = this.i18n.apply(this, notification.message);
            break;
          default:
            break;
        }
      },

      registerSubmit: function (callback) {
        this.$.submit.style.display = 'block';
        this.$.background.style.width = '50%';

        this.$._onSubmitClick = callback;
      },
      _submitData: function (event) {
        this.$._onSubmitClick();
      },
      _reportError: function (response) {
        if ( Rollbar !== undefined ) {
          if ( response instanceof Error ) {
            Rollbar.error('Casper, job-dialog:', response);
          } else if ( response.errors && response.errors[0].internal ) {
            Rollbar.error('Casper, internal: ' + JSON.stringify(response.errors[0].internal));
          }
        }
      }

    });
  </script>
</dom-module>
